<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="initial-scale=1, maximum-scale=1,user-scalable=no"/>
    <title>Simple Map</title>
    <link rel="stylesheet" href="http://js.arcgis.com/3.14/esri/css/esri.css">
    <style>
        html, body, #map {
            height: 100%;
            width: 100%;
            margin: 0;
            padding: 0;
        }
        body {
            background-color: #FFF;
            overflow: hidden;
            font-family: "Trebuchet MS";
        }
    </style>
    <script src="http://js.arcgis.com/3.14/"></script>
    <script src="http://underscorejs.org/underscore-min.js"></script>
    <script>
        var map;

        function unCaseObject(src) {
        	var output = {};
        	for (var p in src) {
        		var pOut = (p + "").toLowerCase();
        		output[pOut] = src[p];
        	}
        	return output;
        }

        function getDefinitionExpressionForLayerAndParams(layer, params) {
        	// Assumes each filter field is a string.
        	// Exact search. Pass param name with trailing ~ for fuzzy match (e.g. city~=QUEENS will match "QUEENS VILLAGE");
        	// Multiple matches: For multiple zips, pass zip=10001&zip=10010 for example.
        	var fieldNames = _.map(layer.fields, function(field) {
	        		return field.name.toLowerCase();
	        	}),
	        	exactMatchFieldNames = _.map(fieldNames, function(fieldName) {
	        		return fieldName + "~";
	        	});
        	fieldNames = _.union(fieldNames, exactMatchFieldNames);
        	var defExParams = _.pick(params, fieldNames);
        	var defEx = _.mapObject(defExParams, function(paramVal, paramName) {
        		var out = [],
        			paramVals = _.flatten([paramVal]),
                    fuzzy = paramName.substring(paramName.length-1) === "~",
        			name = fuzzy?paramName.substring(0, paramName.length - 1):paramName;
        		return _.map(paramVals, function(val) {
	        		if (fuzzy){
		        		return name + " like '%" + val + "%'";
	        		} else {
	        			return name + " = '" + val + "'";
		        	}
        		});
        	});
        	defEx = _.flatten(_.values(defEx)).join(" OR ");
            return defEx;
        }

        require(["esri/arcgis/utils", "esri/layers/FeatureLayer", "esri/tasks/query", "esri/SpatialReference", "dojo/io-query", "dojo/on", "dojo/domReady!"], function (arcgisUtils, FeatureLayer, Query, SpatialReference, ioQuery, on) {
            var params = unCaseObject(dojo.queryToObject(location.search.substring((location.search[0] === "?")?1:0)));

            var featureLayerURL = params["fl"];
            var webMapID = params["webmapid"];
            var basemap = params["basemap"];
            delete params["webmapid"];
            delete params["fl"];
            delete params["basemap"];

            if (featureLayerURL === undefined && webMapID === undefined) {
                console.log("You must use the 'fl' parameter to provide the URL to a featureLayer to display, or the 'webmapid' parameter to provide a webmap Item ID");
                return;
            }

            if (webMapID !== undefined) {
                // WebMap Mode
                arcgisUtils.getItem(webMapID).then( function (item) {
                    var topLayerDefinition = item.itemData.operationalLayers[item.itemData.operationalLayers.length-1];
                    if (topLayerDefinition !== undefined) {
                        var url = topLayerDefinition.url;
                        var layerName = topLayerDefinition.id;
                        var fl = new FeatureLayer(url, {mode: FeatureLayer.MODE_SNAPSHOT, fields: ["*"]});
                        fl.on("load", function (loadEvent) {
                            var defEx = getDefinitionExpressionForLayerAndParams(fl, params);
                            var query = Query();
                            query.where = defEx;
                            query.outSpatialReference = new SpatialReference(4326);
                            fl.queryExtent(query).then(function (queryResponse) {
                                var ext = queryResponse.extent;
                                ext = ext.expand(2);
                                item.item.extent = [[ext.xmin, ext.ymin],[ext.xmax,ext.ymax]];
                                console.log("Nearly there!");
                                arcgisUtils.createMap(item, "map").then(function(response){
                                    map = response.map
                                    map.setExtent(queryResponse.extent, true);
                                    var topLayer = map.getLayer(layerName);
                                    on.once(topLayer, "update-end", function() {
                                        topLayer.setDefinitionExpression(defEx);
                                    });
                                });
                            });
                        });
                    }
                });
                // arcgisUtils.createMap(webMapID, "map").then(function (response) {
                //     map = response.map;

                //     var topLayerId = map.graphicsLayerIds[map.graphicsLayerIds.length-1],
                //         topLayer = map.getLayer(topLayerId);

                //     var defEx = getDefinitionExpressionForLayerAndParams(topLayer, params);
                //     var query = Query();
                //     query.where = defEx;
                //     topLayer.queryExtent(query).then(function (queryResponse) {
                //         map.setExtent(queryResponse.extent, true);
                //     }, function (error) {
                //         console.error("Error getting extent for features: " + error);
                //     });

                //     on.once(topLayer, "update-end", function() {
                //         topLayer.setDefinitionExpression(defEx);
                //     });
                // }, function (error) {
                //     console.error("Error loading WebMap " + webMapID + ": " + error);
                // });
            } else {
                // FeatureLayer mode
                require(["esri/map"], function (Map) {
                    var fl = FeatureLayer(featureLayerURL, {mode: FeatureLayer.MODE_SNAPSHOT, fields: ["*"]});
                    fl.on("load", function (loadEvent) {
                        var defEx = getDefinitionExpressionForLayerAndParams(fl, params);
                        fl.setDefinitionExpression(defEx);
                        var query = Query();
                        query.where = defEx;
                        query.outSpatialReference = new SpatialReference(102100);
                        fl.queryExtent(query).then(function (queryResponse) {
                            if (basemap === undefined) {
                                basemap = "streets";
                            }
                            map = new Map("map", {
                                extent: queryResponse.extent,
                                fitExtent: true,
                                basemap: basemap
                            });
                            map.addLayer(fl);
                        }, function (error) {
                            console.error("Error getting extent for features: " + error);
                        });
                    });
                });
            }
        });
    </script>
</head>

<body>
<div id="map"></div>
</body>
</html>
